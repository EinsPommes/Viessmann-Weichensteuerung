<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weichensteuerung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .servo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .servo-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .servo-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .btn-group {
            width: 100%;
        }
        .status-badge {
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .map-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #trackMap {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 5px;
            position: relative;
            background: #fff;
        }
        .track {
            position: absolute;
            height: 4px;
            background-color: #333;
            transform-origin: 0 0;
        }
        .servo {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: background-color 0.3s;
        }
        .servo.active {
            background-color: green;
        }
        .servo-label {
            position: absolute;
            font-size: 12px;
            transform: translate(-50%, -100%);
            margin-top: -5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Weichensteuerung Web Interface</h1>
        
        <div class="servo-grid" id="servoGrid">
            <!-- Servo-Karten werden hier dynamisch eingefügt -->
        </div>

        <div class="map-container">
            <h2 class="mb-3">Gleisplan</h2>
            <div id="trackMap">
                <!-- Gleise und Servos werden hier dynamisch eingefügt -->
            </div>
        </div>
    </div>

    <script>
        // Servo-Positionen (aus der Skizze)
        const servoPositions = [
            { id: 0, x: 10, y: 20 },
            { id: 1, x: 30, y: 40 },
            { id: 2, x: 35, y: 45 },
            { id: 3, x: 40, y: 40 },
            { id: 4, x: 45, y: 35 },
            { id: 5, x: 50, y: 40 },
            { id: 6, x: 60, y: 45 },
            { id: 7, x: 70, y: 40 },
            { id: 8, x: 80, y: 35 },
            { id: 9, x: 85, y: 40 },
            { id: 10, x: 90, y: 45 }
        ];

        // Gleise zeichnen
        function drawTracks() {
            const map = document.getElementById('trackMap');
            
            // Hauptstrecke
            createTrack(10, 40, 90, 40);
            
            // Schleifen und Abzweigungen
            createTrack(30, 40, 40, 20, 45);  // Obere Schleife
            createTrack(40, 20, 50, 40, -45);
            
            createTrack(60, 40, 70, 20, 45);  // Mittlere Schleife
            createTrack(70, 20, 80, 40, -45);
            
            createTrack(35, 45, 45, 60, -45); // Untere Schleife
            createTrack(45, 60, 55, 45, 45);
        }

        function createTrack(x1, y1, x2, y2, angle = 0) {
            const track = document.createElement('div');
            track.className = 'track';
            
            // Position und Größe berechnen
            const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const rotation = angle || Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            track.style.width = length + '%';
            track.style.left = x1 + '%';
            track.style.top = y1 + '%';
            track.style.transform = `rotate(${rotation}deg)`;
            
            document.getElementById('trackMap').appendChild(track);
        }

        // Servos zeichnen
        function drawServos() {
            const map = document.getElementById('trackMap');
            
            servoPositions.forEach(pos => {
                const servo = document.createElement('div');
                servo.className = 'servo';
                servo.id = `map-servo-${pos.id}`;
                servo.style.left = pos.x + '%';
                servo.style.top = pos.y + '%';
                
                const label = document.createElement('div');
                label.className = 'servo-label';
                label.textContent = `S${pos.id + 1}`;
                
                servo.appendChild(label);
                map.appendChild(servo);
            });
        }

        // Servo-Karten erstellen
        function createServoCards() {
            const servoGrid = document.getElementById('servoGrid');
            
            for (let i = 0; i < servoPositions.length; i++) {
                const card = document.createElement('div');
                card.className = 'servo-card';
                card.innerHTML = `
                    <h3>Servo ${i + 1}</h3>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-danger" onclick="setPosition(${i}, 'left')">Links</button>
                        <button type="button" class="btn btn-success" onclick="setPosition(${i}, 'right')">Rechts</button>
                    </div>
                    <div class="status-badge bg-secondary text-white text-center" id="status-${i}">
                        Position: Links
                    </div>
                `;
                servoGrid.appendChild(card);
            }
        }

        // Servo-Position setzen
        async function setPosition(servoId, position) {
            try {
                const response = await fetch(`/api/servo/${servoId}/${position}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    updateStatus(servoId, position);
                } else {
                    alert(`Fehler: ${data.error}`);
                }
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler bei der Kommunikation mit dem Server');
            }
        }

        // Status aktualisieren
        function updateStatus(servoId, position) {
            // Status-Badge aktualisieren
            const statusBadge = document.getElementById(`status-${servoId}`);
            statusBadge.textContent = `Position: ${position === 'left' ? 'Links' : 'Rechts'}`;
            statusBadge.className = `status-badge ${position === 'left' ? 'bg-danger' : 'bg-success'} text-white text-center`;
            
            // Servo auf der Karte aktualisieren
            const mapServo = document.getElementById(`map-servo-${servoId}`);
            if (mapServo) {
                mapServo.className = `servo ${position === 'right' ? 'active' : ''}`;
            }
        }

        // Status regelmäßig aktualisieren
        async function updateAllStatus() {
            try {
                const response = await fetch('/api/servos/status');
                const data = await response.json();
                
                if (response.ok) {
                    Object.entries(data).forEach(([servoId, position]) => {
                        updateStatus(parseInt(servoId), position);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Aktualisieren des Status:', error);
            }
        }

        // Initialisierung
        createServoCards();
        drawTracks();
        drawServos();
        
        // Status alle 5 Sekunden aktualisieren
        setInterval(updateAllStatus, 5000);
        updateAllStatus();  // Initial update
    </script>
</body>
</html>
